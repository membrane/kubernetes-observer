<html ng-app="kubernetes-observer">
<script src="angular.min.js">
</script>
<script src="jquery-2.2.2.min.js">
</script>
<style type="text/css">
    .scrollable0{
        overflow:scroll;
        height:200px;
        width:700px;
        float: left;
    }
    .scrollable1{
        overflow:scroll;
        height:200px;
        width:700px;
        float: right;
    }
</style>
<head>
    <title>Kubernetes Observer</title>
</head>
<body>
<div ng-controller="podsCtrl">
    <select name="choose"  id="choose" value="{{choosenpod}}" ng-model="choose">
        <option ng-repeat="pod in pods" value="{{pod.metadata.generateName}}">{{pod.metadata.name}}</option>
    </select>
    <!--Automatisch auf Nachfolgepod bleiben: <input type="checkbox" name="nachfolgepod" id="nachfolgepod">-->
    <div >
        <div ng-repeat="url in urls">
            <div class="{{url.i}}"><pre>{{getressource(url.u)}}</pre></div>
        </div>
    </div>

</div>

<script>
    var timeout=2000;
    angular.module('kubernetes-observer', [])
            .controller('podsCtrl', function($scope, $http, $timeout, Getressource){
                var data={response:null, calls:null};
                var choosenpod=null;
                $scope.getressource = Getressource;

                $scope.$watch('choose', function(newValue, oldValue) {
                    console.log(newValue, oldValue);
                    choosenpod=newValue;
                });

                var poller = function() {

                    //console.log(choosenpod);
                    $http.get('/api/v1/namespaces/default/pods').then(function(r) {
                        data.response = r.data.items;
                        $scope.pods = data.response;
                        $scope.pods.forEach(function (el) {
                            el.urls = [];
                            var i = 0;
                            el.spec.containers.forEach(function (e) {
                                el.urls.push({
                                    u: "/api/v1/namespaces/" + el.metadata.namespace + "/pods/" + el.metadata.name + "/log?container=" + e.name + "&follow=false",
                                    i: "scrollable" + i
                                });
                                i++;
                                i %= 2;
                            });

                        });

                        $scope.pods.forEach(function (el) {
                            if (el.metadata.generateName === choosenpod) {
                                $scope.urls = el.urls;
                            }
                        });
                        $scope.choose=choosenpod;

                    });
                    data.calls++;
                    $timeout(poller, timeout);

                };
                poller();

            })
            .factory('Getressource', function() {
                var content= undefined;
                return  function(url){
                        $.ajax({
                           url: url,
                           success: function (result) {
                               if (result.isOk == false) alert(result.message);
                               content=  result;
                           },
                           async: false
                        });
                        $(".scrollable0").each(function(index, el){
                            el.scrollTop= 9999999;
                        });
                        $(".scrollable1").each(function(index, el){
                            el.scrollTop= 9999999;
                        });
                        return content;
                    }

            });



</script>


</body>
</html>